language: ruby
rvm: 
  - 2.2.0
cache: true
env: 
  global:
    - CI_REPORTS=shippable/testresults COVERAGE_REPORTS=shippable/codecoverage RAILS_ENV=test
    - RDS_HOSTNAME=127.0.0.1 RDS_USERNAME=shippable RDS_PASSWORD="" RDS_DB_NAME=test RDS_PORT=5432
    - AWSAccessKeyId=AKIAI5LEGKJIVHEO3XCQ 
    - secure: x1d67YqcSFYs9eyFlCWGWnrTLecsw++Z3Bk8Y7cH9M4jN0I0R6XzFY4vdNLBIRBCwMmuSeELQhjB6uLjrlRVEgwPaVcQuo5hudAWc9fqWZQUU7+CDIy83y4FJNpikaviHIj+1FV5FN2GNNeTtol+/XrPNZX3WyqFWWHuoIcATOJVQ/IJgqLj8lgm+Q7imEaRoB7c6B6NgaFWmLMWRDGJoetV3iCy0h0XMD/WF/5hJAMdj8GqMpNaKeOMc/zf0ZbMWSHqjxjKNP2BVrqNPRCzMhzTME5mq0QASmgXx7uvUC8dT3BvT1mLQPUOnHK5QRKZZAoIQmzfDerAzre17kf1Cw==
before_install:
    # setup rvm
    - source ~/.rvm/scripts/rvm
    - rvm install $SHIPPABLE_RUBY --verify-downloads 1
    - source ~/.bashrc && ~/.rvm/scripts/rvm && rvm use $SHIPPABLE_RUBY
    - SUDO=$(which sudo) && $SUDO pip install awsebcli
install:
  - bundle install --gemfile="Gemfile"
  - ruby -v
before_script:
  - mkdir -p ~/.aws
  - echo '[profile eb-cli]' > ~/.aws/config
  - echo "aws_access_key_id = $AWSAccessKeyId" >> ~/.aws/config
  - echo "aws_secret_access_key = $AWSSecretKey" >> ~/.aws/config
  - "rm -rf $CI_REPORTS && mkdir -p $CI_REPORTS"
  - "rm -rf $COVERAGE_REPORTS && mkdir -p $COVERAGE_REPORTS"
  - cp config/database.yml.shippable config/database.yml
  - psql -c 'create database web_test;' -U postgres
  - rake db:create
  - rake db:migrate
script:
  - bundle exec rake spec --trace
after_success:
  - eb init && eb deploy --debug --verbose --timeout 30

  #Databse setup
  # - shippable_retry sudo apt-get update
  # - shippable_retry sudo apt-get install -y python-dev
  # - shippable_retry sudo apt-get install -y postgresql-9.3 postgresql-contrib-9.3 postgresql-server-dev-9.3
  # - sudo echo "host all all localhost trust" > /etc/postgresql/9.3/main/pg_hba.conf
  # - sudo echo "local all all trust" >> /etc/postgresql/9.3/main/pg_hba.conf
  # - sudo service postgresql start


