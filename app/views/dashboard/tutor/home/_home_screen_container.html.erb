<section class="dashboard-content tutor-home-page">

  <div class="row">
    <div class="small-12 columns">
      <div class="upcoming-appts">
        <p class="dash-home-header dash-home-top-row">UPCOMING APPOINTMENTS</p>
        <% if @tutor.appointments.where(status: 'Scheduled').count == 0 %>
          <div class="box no-appts">
            <h5 class="no-appts-message">You currently have no scheduled appointments</h5>
            <p class="list-title">To recieve more bookings, try:</p>
            <p class="list-item">&#8226; Sharing your profile page link:</p>
            <p class="list-item profile-link">www.axontutors.com/tutors/<%= @tutor.slug %></p>
            <p class="list-item">&#8226; Increasing your availability in your <%= link_to 'Schedule', schedule_tutor_path(@tutor.slug) %></p>
            <p class="list-item">&#8226; Adding more courses in your <%= link_to 'Courses', tutor_courses_path(@tutor.slug) %></p>
          </div>
        <% else %>
          <table class="no-top-margin no-top-border-radius">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Subject</th>
                <th>Student</th>
                <th>Contact</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @tutor.appointments.where(status: 'Scheduled').each do |appt| %>
              <% student = Student.find(appt.student_id) %>
                <tr>
                  <td><%= appt.start_time.strftime("%b %-d") %></td>
                  <td><%= appt.start_time.strftime("%l:%M%P") %></td>
                  <td><%= Course.find(appt.course_id).formatted_name %></td>
                  <td><%= student.full_name %></td>
                  <td><%= student.email %></td>
                  <td><a href="#" data-reveal-id="confirm-cancel-appt-<%= appt.id %>" class="custom-button blue">Cancel</a>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="small-12 columns">
      <p class="dash-home-header">METRICS</p>
    </div>
  </div>

  <div class="row">
    <div class="small-12 columns">
      <div class="box">
        <div class="row">
          <div class="small-12 medium-3 columns">
            <h3 class="metrics">$<%= @tutor.total_income %></h3>
            <p class="metrics">Total Revenue</p>
          </div>
          <div class="small-12 medium-3 columns">
            <h3 class="metrics"><%= @tutor.appointments.count %></h3>
            <p class="metrics">Total Appointments</p>
          </div>
          <div class="small-12 medium-3 columns">
            <h3 class="metrics">0</h3>
            <p class="metrics">Fucks Given</p>
          </div>
          <div class="small-12 medium-3 columns">
            <h3 class="metrics">3</h3>
            <p class="metrics">Felony Convictions</p>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="row">
    <div class="small-12 medium-4 columns">
      <div class="margin-top-2em center">
        <p class="dash-home-header">YOUR CAMPUS MANAGER</p>
        <div class="box height-22em">
          <%= image_tag(@school.campus_manager.profile_pic_url, class: 'campus_manager_pic') %>
          <h6 class="name"><%= @school.campus_manager.full_name %></h6>
          <p><%= @school.campus_manager.email %></p>
          <p><%= @school.campus_manager.phone_number %></p>
        </div>
      </div>
    </div>

    <div class="small-12 medium-8 columns">
      <div class="margin-top-2em center">
        <p class="dash-home-header">APPOINTMENT HISTORY</p>
        <% if @tutor.appointments.count == 0 %>
          <div class="box height-22em">
            <div class="no-appts">
              <h5 class="no-appts-message no-appt-history-message">You currently have no appointment history.</h5>
            </div>
          </div>
        <% else %>
          <table class="no-top-margin no-top-border-radius">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Student</th>
              </tr>
            </thead>
            <tbody>
              <% @tutor.appointments.each do |appt| %>
                <tr>
                  <td><%= appt.start_time.strftime("%b %-d") %></td>
                  <td><%= appt.start_time.strftime("%l:%M%P") %></td>
                  <td><%= Course.find(appt.course_id).formatted_name %></td>
                  <td><%= appt.status %></td>
                  <td><%= appt.student.full_name %></td>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
      </div>
    </div>
  </div>



</section>


<!-- Reveal modals for confirming Appointment cancellation -->

<% @tutor.appointments.where(status: 'Scheduled').each do |appt| %>
  <div id="confirm-cancel-appt-<%= appt.id %>" class="reveal-modal medium" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
    <h6 id="modalTitle">Are you sure you want to cancel this appointment?</h6>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Subject</th>
                <th>Student</th>
                <th>Contact</th>
              </tr>
            </thead>
            <tbody>
              <% student = Student.find(appt.student_id) %>
              <tr>
                <td><%= appt.start_time.strftime("%b %-d") %></td>
                <td><%= appt.start_time.strftime("%l:%M%P") %></td>
                <td><%= Course.find(appt.course_id).formatted_name %></td>
                <td><%= student.full_name %></td>
                <td><%= student.email %></td>
              </tr>
            </tbody>
          </table>
    <p>As soon as you cancel, the student will be notified and refunded.</p>
    <a class="close-reveal-modal custom-button override-foundation" aria-label="Close">No, don't cancel</a>
    <%= form_for appt, url: cancel_appt_tutor_path(@tutor.slug, appt.id), class: 'cancel-appt-form-button', method: :put do |f| %>
      <%= f.hidden_field :status, value: 'Cancelled' %>
      <%= f.submit 'Yes, cancel', class: 'custom-button blue' %>
    <% end %>
  </div>
<% end %>